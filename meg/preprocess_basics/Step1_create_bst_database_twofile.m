% Script generated by Brainstorm (30-Jan-2015)

SubjectName = {'bildc3315', 'bildc3317', 'bildc3323'};
nSubj = length(SubjectName);
SubjectRaw = {'/Users/zqi/Documents/MIT/MEG/brainstorm_raw/bildc3315_1_tsss_mc.fif', ...
    '/Users/zqi/Documents/MIT/MEG/brainstorm_raw/bildc3315_2_tsss_mc.fif', ...
    '/Users/zqi/Documents/MIT/MEG/brainstorm_raw/bildc3317_1_tsss_mc.fif', ...
    '/Users/zqi/Documents/MIT/MEG/brainstorm_raw/bildc3317_2_tsss_mc.fif', ...
    '/Users/zqi/Documents/MIT/MEG/brainstorm_raw/bildc3323_1_trans_tsss.fif', ...
    '/Users/zqi/Documents/MIT/MEG/brainstorm_raw/bildc3323_2_trans_tsss.fif'};

for subj = 1:nSubj
    
    % Input files
    sFiles1 = [];
    sFiles2 = [];
    %SubjectNames = {...
    %    'MEGEEG01'};
    SubjectNames = SubjectName(subj);
    
    RawFiles = {SubjectRaw(2*subj-1), SubjectRaw(2*subj)};
    
    % Start a new report
    bst_report('Start', sFiles);
    
    % Process: Create link to raw file
    sFiles1 = bst_process('CallProcess', 'process_import_data_raw', ...
        sFiles1, [], ...
        'subjectname', SubjectNames{1}, ...
        'datafile', {RawFiles{1}, 'FIF'}, ...
        'channelreplace', 0, ...
        'channelalign', 1);
    sFiles2 = bst_process('CallProcess', 'process_import_data_raw', ...
        sFiles2, [], ...
        'subjectname', SubjectNames{1}, ...
        'datafile', {RawFiles{2}, 'FIF'}, ...
        'channelreplace', 0, ...
        'channelalign', 1);
    
    % Process: Read from channel
    sFiles1 = bst_process('CallProcess', 'process_evt_read', ...
        sFiles1, [], ...
        'stimchan', 'STI101', ...
        'trackmode', 1, ...  % Value: detect the changes of channel value
        'zero', 0);
    sFiles2 = bst_process('CallProcess', 'process_evt_read', ...
        sFiles2, [], ...
        'stimchan', 'STI101', ...
        'trackmode', 1, ...  % Value: detect the changes of channel value
        'zero', 0);
    
    % Process: Import MEG/EEG: Events
    sFiles_trials1 = bst_process('CallProcess', 'process_import_data_event', ...
        sFiles1, [], ...
        'subjectname', SubjectNames{1}, ...
        'condition', '111,114,212,213,123,122,115,214,124,250,251', ...
        'eventname', '111,114,212,213,123,122,115,214,124,250,251', ...
        'timewindow', [], ...
        'epochtime', [-0.1, 0.5], ...
        'createcond', 1, ...
        'ignoreshort', 1, ...
        'usectfcomp', 1, ...
        'usessp', 1, ...
        'freq', [], ...
        'baseline', [-0.1, -0.001]);
    sFiles_trials2 = bst_process('CallProcess', 'process_import_data_event', ...
        sFiles2, [], ...
        'subjectname', SubjectNames{1}, ...
        'condition', '111,114,212,213,123,122,115,214,124,250,251', ...
        'eventname', '111,114,212,213,123,122,115,214,124,250,251', ...
        'timewindow', [], ...
        'epochtime', [-0.1, 0.5], ...
        'createcond', 1, ...
        'ignoreshort', 1, ...
        'usectfcomp', 1, ...
        'usessp', 1, ...
        'freq', [], ...
        'baseline', [-0.1, -0.001]);
    
    sFiles_trials = [sFiles_trials1 sFiles_trials2];
    
    % Process: Compute noise covariance: 
    sFiles = bst_process('CallProcess', 'process_noisecov', ...
        sFiles_trials, [], ...
        'baseline', [-0.1, -0.001], ...
        'target', 1, ...
        'dcoffset', 1, ...
        'method', 1, ...  % Full noise covariance matrix
        'copycond', 0, ...
        'copysubj', 0);
    
    % Process: Average: By condition (subject average)
    sFiles_avg = bst_process('CallProcess', 'process_average', ...
        sFiles, [], ...
        'avgtype', 3, ...
        'avg_func', 1, ...  % Arithmetic average: mean(x)
        'keepevents', 0);
    
    % Process: Difference A-B
    % 1-6 is: 111,114,122,123,212,213
    %123 vs 111
    sFiles_dif1 = bst_process('CallProcess', 'process_diff_ab', ...
        sFiles_avg(4), sFiles_avg(1));
    %212 vs 111
    sFiles_dif2 = bst_process('CallProcess', 'process_diff_ab', ...
        sFiles_avg(5), sFiles_avg(1));
    
    
    % Process: Compute head model
    sFiles = bst_process('CallProcess', 'process_headmodel', ...
        sFiles, [], ...
        'comment', '', ...
        'sourcespace', 1, ...
        'meg', 3, ...  % Overlapping spheres
        'eeg', 1, ...  %
        'ecog', 1, ...  %
        'seeg', 1, ...
        'openmeeg', struct(...
        'BemFiles', {{}}, ...
        'BemNames', {{'Scalp', 'Skull', 'Brain'}}, ...
        'BemCond', [1, 0.0125, 1], ...
        'BemSelect', [1, 1, 1], ...
        'isAdjoint', 0, ...
        'isAdaptative', 1, ...
        'isSplit', 0, ...
        'SplitLength', 4000));
 
     % Process: Compute sources
    sFiles_sources = bst_process('CallProcess', 'process_inverse', ...
        sFiles, [], ...
        'comment', '', ...
        'method', 1, ...  % Minimum norm estimates (wMNE)
        'wmne', struct(...
        'NoiseCov', [], ...
        'InverseMethod', 'wmne', ...
        'ChannelTypes', {{}}, ...
        'SNR', 3, ...
        'diagnoise', 0, ...
        'SourceOrient', {{'fixed'}}, ...
        'loose', 0.2, ...
        'depth', 1, ...
        'weightexp', 0.5, ...
        'weightlimit', 10, ...
        'regnoise', 1, ...
        'magreg', 0.1, ...
        'gradreg', 0.1, ...
        'eegreg', 0.1, ...
        'ecogreg', 0.1, ...
        'seegreg', 0.1, ...
        'fMRI', [], ...
        'fMRIthresh', [], ...
        'fMRIoff', 0.1, ...
        'pca', 1), ...
        'sensortypes', 'MEG, MEG MAG, MEG GRAD', ...
        'output', 1);  % Kernel only: shared
    
%     % Process: Scouts time series: [68 scouts]
%     sFiles = bst_process('CallProcess', 'process_extract_scout', ...
%         sFiles_trials, [], ...
%         'timewindow', [-0.1, 0.5], ...
%         'scouts', {'Desikan-Killiany', {'bankssts L', 'bankssts R', 'caudalanteriorcingulate L', 'caudalanteriorcingulate R', 'caudalmiddlefrontal L', 'caudalmiddlefrontal R', 'cuneus L', 'cuneus R', 'entorhinal L', 'entorhinal R', 'frontalpole L', 'frontalpole R', 'fusiform L', 'fusiform R', 'inferiorparietal L', 'inferiorparietal R', 'inferiortemporal L', 'inferiortemporal R', 'insula L', 'insula R', 'isthmuscingulate L', 'isthmuscingulate R', 'lateraloccipital L', 'lateraloccipital R', 'lateralorbitofrontal L', 'lateralorbitofrontal R', 'lingual L', 'lingual R', 'medialorbitofrontal L', 'medialorbitofrontal R', 'middletemporal L', 'middletemporal R', 'paracentral L', 'paracentral R', 'parahippocampal L', 'parahippocampal R', 'parsopercularis L', 'parsopercularis R', 'parsorbitalis L', 'parsorbitalis R', 'parstriangularis L', 'parstriangularis R', 'pericalcarine L', 'pericalcarine R', 'postcentral L', 'postcentral R', 'posteriorcingulate L', 'posteriorcingulate R', 'precentral L', 'precentral R', 'precuneus L', 'precuneus R', 'rostralanteriorcingulate L', 'rostralanteriorcingulate R', 'rostralmiddlefrontal L', 'rostralmiddlefrontal R', 'superiorfrontal L', 'superiorfrontal R', 'superiorparietal L', 'superiorparietal R', 'superiortemporal L', 'superiortemporal R', 'supramarginal L', 'supramarginal R', 'temporalpole L', 'temporalpole R', 'transversetemporal L', 'transversetemporal R'}}, ...
%         'scoutfunc', 1, ...  % Mean
%         'isflip', 1, ...
%         'isnorm', 0, ...
%         'concatenate', 0, ...
%         'save', 1, ...
%         'addrowcomment', 1, ...
%         'addfilecomment', 1);
    
%     % Process: Scouts time series: [68 scouts]
%     sFiles = bst_process('CallProcess', 'process_extract_scout', ...
%         sFiles_sources, [], ...
%         'timewindow', [-0.1, 0.5], ...
%         'scouts', {'Desikan-Killiany', {'bankssts L', 'bankssts R', 'caudalanteriorcingulate L', 'caudalanteriorcingulate R', 'caudalmiddlefrontal L', 'caudalmiddlefrontal R', 'cuneus L', 'cuneus R', 'entorhinal L', 'entorhinal R', 'frontalpole L', 'frontalpole R', 'fusiform L', 'fusiform R', 'inferiorparietal L', 'inferiorparietal R', 'inferiortemporal L', 'inferiortemporal R', 'insula L', 'insula R', 'isthmuscingulate L', 'isthmuscingulate R', 'lateraloccipital L', 'lateraloccipital R', 'lateralorbitofrontal L', 'lateralorbitofrontal R', 'lingual L', 'lingual R', 'medialorbitofrontal L', 'medialorbitofrontal R', 'middletemporal L', 'middletemporal R', 'paracentral L', 'paracentral R', 'parahippocampal L', 'parahippocampal R', 'parsopercularis L', 'parsopercularis R', 'parsorbitalis L', 'parsorbitalis R', 'parstriangularis L', 'parstriangularis R', 'pericalcarine L', 'pericalcarine R', 'postcentral L', 'postcentral R', 'posteriorcingulate L', 'posteriorcingulate R', 'precentral L', 'precentral R', 'precuneus L', 'precuneus R', 'rostralanteriorcingulate L', 'rostralanteriorcingulate R', 'rostralmiddlefrontal L', 'rostralmiddlefrontal R', 'superiorfrontal L', 'superiorfrontal R', 'superiorparietal L', 'superiorparietal R', 'superiortemporal L', 'superiortemporal R', 'supramarginal L', 'supramarginal R', 'temporalpole L', 'temporalpole R', 'transversetemporal L', 'transversetemporal R'}}, ...
%         'scoutfunc', 1, ...  % Mean
%         'isflip', 1, ...
%         'isnorm', 0, ...
%         'concatenate', 0, ...
%         'save', 1, ...
%         'addrowcomment', 1, ...
%         'addfilecomment', 1);
    
    
    % Save and display report
    ReportFile = bst_report('Save', sFiles);
    bst_report('Open', ReportFile);
    
    fname = [SubjectName{subj} '_sFiles.mat'];
    %save(fname,'sFiles_trials','sFiles_avg' etc
    
end
